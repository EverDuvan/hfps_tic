{% extends 'inventory/base.html' %}
{% load static %}

{% block title %}Dashboard{% endblock %}
{% block page_title %}Dashboard de Gestión{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>




<!-- KPI Cards -->
<div
    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
    <div class="card" style="border-left: 4px solid var(--primary);">
        <h3>Total Equipos</h3>
        <p style="font-size: 2.5rem; font-weight: 800; color: #1f2937;">{{ total_equipment }}</p>
    </div>
    <div class="card" style="border-left: 4px solid #4ade80;">
        <h3>Equipos Activos</h3>
        <p style="font-size: 2.5rem; font-weight: 800; color: #16a34a;">{{ active_equipment }}</p>
    </div>
    <div class="card" style="border-left: 4px solid #facc15;">
        <h3>Mantenimientos (Histórico)</h3>
        <p style="font-size: 2.5rem; font-weight: 800; color: #ca8a04;">{{ maintenance_count }}</p>
    </div>
    <div class="card" style="border-left: 4px solid #a855f7;">
        <h3>Total Entregas</h3>
        <p style="font-size: 2.5rem; font-weight: 800; color: #7e22ce;">{{ handover_count }}</p>
    </div>
</div>

<!-- Charts Row -->
<div class="grid-2" style="margin-bottom: 2rem;">
    <div class="card">
        <h3>Estado de Equipos</h3>
        <div style="height: 300px; display: flex; justify-content: center;">
            <canvas id="statusChart"></canvas>
        </div>
    </div>
    <div class="card">
        <h3>Distribución por Tipo</h3>
        <div style="height: 300px;">
            <canvas id="typeChart"></canvas>
        </div>
    </div>
</div>

<!-- Bottom Row: Areas & Recents -->
<div style="display: grid; grid-template-columns: 1fr 2fr; gap: 1.5rem;">
    <!-- Top Areas Table/Chart -->
    <div class="card">
        <h3>Top Áreas con Equipos</h3>
        <canvas id="areaChart"></canvas>
    </div>

    <!-- Recent Activity Tabs/List -->
    <div class="card">
        <h3>Actividad Reciente</h3>

        <div style="margin-top: 1rem;">
            <h4 style="color: #6b7280; text-transform: uppercase; font-size: 0.75rem; margin-bottom: 0.5rem;">
                Mantenimientos</h4>
            <table style="margin-bottom: 1.5rem;">
                <tbody>
                    {% for m in recent_maintenance %}
                    <tr>
                        <td style="padding: 0.5rem;"><strong>{{ m.date|date:"d M" }}</strong></td>
                        <td style="padding: 0.5rem;">{{ m.equipment.brand }} {{ m.equipment.model }}</td>
                        <td style="padding: 0.5rem; color: #6b7280;">{{ m.performed_by.username }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <h4 style="color: #6b7280; text-transform: uppercase; font-size: 0.75rem; margin-bottom: 0.5rem;">Entregas
            </h4>
            <table>
                <tbody>
                    {% for h in recent_handovers %}
                    <tr>
                        <td style="padding: 0.5rem;"><strong>{{ h.date|date:"d M" }}</strong></td>
                        <td style="padding: 0.5rem;">{{ h.get_type_display }}</td>
                        <td style="padding: 0.5rem; color: #6b7280;">{{ h.destination_area.name|default:"-" }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>


<!-- Alerts Section -->
<!-- Upcoming Maintenance Alert -->
{% if upcoming_schedules or upcoming_maintenance_records %}
<div class="card" style="border-left: 4px solid #f59e0b; margin-bottom: 2rem; background-color: #fffbeb;">
    <h3 style="color: #b45309; margin-top: 0; display: flex; align-items: center; gap: 0.5rem;">
        ⚠️ Mantenimientos Próximos (30 días)
    </h3>
    <table style="width: 100%; border-collapse: collapse; margin-top: 0.5rem;">
        <thead>
            <tr style="text-align: left; border-bottom: 1px solid #fcd34d;">
                <th style="padding: 0.5rem; color: #92400e;">Equipo</th>
                <th style="padding: 0.5rem; color: #92400e;">Serie</th>
                <th style="padding: 0.5rem; color: #92400e;">Fecha Programada</th>
                <th style="padding: 0.5rem; color: #92400e;">Fuente</th>
                <th style="padding: 0.5rem;">Acción</th>
            </tr>
        </thead>
        <tbody>
            {% for s in upcoming_schedules %}
            <tr style="border-bottom: 1px solid #fef3c7;">
                <td style="padding: 0.5rem; color: #b45309;">{{ s.equipment.get_type_display }} - {{ s.equipment.brand }} {{ s.equipment.model }}</td>
                <td style="padding: 0.5rem; color: #b45309;">{{ s.equipment.serial_number }}</td>
                <td style="padding: 0.5rem; font-weight: bold; color: #d97706;">{{ s.scheduled_date|date:"d M Y" }}</td>
                <td style="padding: 0.5rem; color: #b45309;">Cronograma</td>
                <td style="padding: 0.5rem;">
                    <a href="{% url 'inventory:maintenance_create' %}?equipment={{ s.equipment.id }}"
                        style="color: #d97706; text-decoration: underline; font-size: 0.9rem;">Realizar</a>
                </td>
            </tr>
            {% endfor %}
            
            {% for m in upcoming_maintenance_records %}
            <tr style="border-bottom: 1px solid #fef3c7;">
                <td style="padding: 0.5rem; color: #b45309;">{{ m.equipment.get_type_display }} - {{ m.equipment.brand }} {{ m.equipment.model }}</td>
                <td style="padding: 0.5rem; color: #b45309;">{{ m.equipment.serial_number }}</td>
                <td style="padding: 0.5rem; font-weight: bold; color: #d97706;">{{ m.next_maintenance_date|date:"d M Y" }}</td>
                <td style="padding: 0.5rem; color: #b45309;">Historial (Anterior)</td>
                <td style="padding: 0.5rem;">
                    <a href="{% url 'inventory:maintenance_create' %}?equipment={{ m.equipment.id }}"
                        style="color: #d97706; text-decoration: underline; font-size: 0.9rem;">Realizar</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

{% if low_stock_peripherals %}
<div class="card" style="border-left: 4px solid #ef4444; margin-bottom: 2rem; background-color: #fef2f2;">
    <h3 style="color: #b91c1c; margin-top: 0; display: flex; align-items: center; gap: 0.5rem;">
        ⚠️ Alerta de Stock Bajo
    </h3>
    <table style="width: 100%; border-collapse: collapse; margin-top: 0.5rem;">
        <thead>
            <tr style="text-align: left; border-bottom: 1px solid #fecaca;">
                <th style="padding: 0.5rem; color: #991b1b;">Periférico</th>
                <th style="padding: 0.5rem; color: #991b1b;">Stock Actual</th>
                <th style="padding: 0.5rem; color: #991b1b;">Mínimo</th>
                <th style="padding: 0.5rem;">Acción</th>
            </tr>
        </thead>
        <tbody>
            {% for p in low_stock_peripherals %}
            <tr style="border-bottom: 1px solid #fee2e2;">
                <td style="padding: 0.5rem; color: #b91c1c;">{{ p.type.name }} - {{ p.brand }} {{ p.model }}</td>
                <td style="padding: 0.5rem; font-weight: bold; color: #dc2626;">{{ p.quantity }}</td>
                <td style="padding: 0.5rem; color: #b91c1c;">{{ p.min_stock_level }}</td>
                <td style="padding: 0.5rem;">
                    <a href="{% url 'inventory:peripheral_edit' p.pk %}"
                        style="color: #dc2626; text-decoration: underline; font-size: 0.9rem;">Gestionar</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<!-- Expired Warranty Alert -->
{% if warranty_expired %}
<div class="card" style="border-left: 4px solid #d97706; margin-bottom: 2rem; background-color: #fffbeb;">
    <h3 style="color: #92400e; margin-top: 0; display: flex; align-items: center; gap: 0.5rem;">
        ⚠️ Garantía Vencida
    </h3>
    <table style="width: 100%; border-collapse: collapse; margin-top: 0.5rem;">
        <thead>
            <tr style="text-align: left; border-bottom: 1px solid #fcd34d;">
                <th style="padding: 0.5rem; color: #92400e;">Equipo</th>
                <th style="padding: 0.5rem; color: #92400e;">Serie</th>
                <th style="padding: 0.5rem; color: #92400e;">Vencimiento</th>
                <th style="padding: 0.5rem;">Acción</th>
            </tr>
        </thead>
        <tbody>
            {% for e in warranty_expired %}
            <tr style="border-bottom: 1px solid #fef3c7;">
                <td style="padding: 0.5rem; color: #b45309;">{{ e.get_type_display }} - {{ e.brand }} {{ e.model }}</td>
                <td style="padding: 0.5rem; color: #b45309;">{{ e.serial_number }}</td>
                <td style="padding: 0.5rem; font-weight: bold; color: #d97706;">{{ e.warranty_expiry|date:"d M Y" }}
                </td>
                <td style="padding: 0.5rem;">
                    <a href="{% url 'inventory:equipment_detail' e.pk %}"
                        style="color: #d97706; text-decoration: underline; font-size: 0.9rem;">Ver</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<!-- Expired Lifespan Alert -->
{% if lifespan_expired %}
<div class="card" style="border-left: 4px solid #ef4444; margin-bottom: 2rem; background-color: #fef2f2;">
    <h3 style="color: #b91c1c; margin-top: 0; display: flex; align-items: center; gap: 0.5rem;">
        ⚠️ Vida Útil Vencida
    </h3>
    <table style="width: 100%; border-collapse: collapse; margin-top: 0.5rem;">
        <thead>
            <tr style="text-align: left; border-bottom: 1px solid #fecaca;">
                <th style="padding: 0.5rem; color: #991b1b;">Equipo</th>
                <th style="padding: 0.5rem; color: #991b1b;">Serie</th>
                <th style="padding: 0.5rem; color: #991b1b;">Fin Vida Útil</th>
                <th style="padding: 0.5rem;">Acción</th>
            </tr>
        </thead>
        <tbody>
            {% for e in lifespan_expired %}
            <tr style="border-bottom: 1px solid #fee2e2;">
                <td style="padding: 0.5rem; color: #b91c1c;">{{ e.get_type_display }} - {{ e.brand }} {{ e.model }}</td>
                <td style="padding: 0.5rem; color: #b91c1c;">{{ e.serial_number }}</td>
                <td style="padding: 0.5rem; font-weight: bold; color: #dc2626;">{{ e.end_of_life_date|date:"d M Y" }}
                </td>
                <td style="padding: 0.5rem;">
                    <a href="{% url 'inventory:equipment_detail' e.pk %}"
                        style="color: #dc2626; text-decoration: underline; font-size: 0.9rem;">Ver</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<script>
    // Data from Django
    const statusData = {{ status_data| safe }};
    const typeData = {{ type_data| safe }};
    const areaData = {{ area_data| safe }};

    // Helper to process data
    function processData(data, labelKey, valueKey) {
        return {
            labels: data.map(d => d[labelKey]),
            values: data.map(d => d[valueKey])
        };
    }

    const statusProcessed = {
        labels: statusData.map(d => d.status), // Might need mapping to human readable if needed, or django template filter
        values: statusData.map(d => d.count)
    };

    // Status Chart
    new Chart(document.getElementById('statusChart'), {
        type: 'doughnut',
        data: {
            labels: statusData.map(d => d.status),
            datasets: [{
                data: statusData.map(d => d.count),
                backgroundColor: ['#4ade80', '#f87171', '#facc15', '#60a5fa'],
            }]
        },
        options: {
            plugins: {
                legend: { position: 'bottom' }
            }
        }
    });

    // Type Chart
    new Chart(document.getElementById('typeChart'), {
        type: 'bar',
        data: {
            labels: typeData.map(d => d.type),
            datasets: [{
                label: 'Cantidad',
                data: typeData.map(d => d.count),
                backgroundColor: '#3b82f6',
                borderRadius: 4
            }]
        },
        options: {
            scales: { y: { beginAtZero: true } },
            plugins: { legend: { display: false } }
        }
    });

    // Area Chart (Horizontal Bar)
    new Chart(document.getElementById('areaChart'), {
        type: 'bar',
        data: {
            labels: areaData.map(d => d.area__name),
            datasets: [{
                label: 'Equipos',
                data: areaData.map(d => d.count),
                backgroundColor: '#8b5cf6',
                borderRadius: 4
            }]
        },
        options: {
            indexAxis: 'y',
            scales: { x: { beginAtZero: true } },
            plugins: { legend: { display: false } }
        }
    });
</script>
{% endblock %}