{% extends 'inventory/base.html' %}

{% block title %}Cronograma de Mantenimiento{% endblock %}
{% block page_title %}Cronograma de Mantenimiento {{ year }}{% endblock %}

{% block content %}
<style>
    .schedule-container {
        overflow-x: auto;
        max-width: 100%;
        background: white;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .schedule-table {
        border-collapse: collapse;
        width: max-content;
        min-width: 100%;
    }

    .schedule-table th,
    .schedule-table td {
        border: 1px solid #e5e7eb;
        text-align: center;
        padding: 4px;
        font-size: 0.75rem;
    }

    .sticky-col {
        position: sticky;
        left: 0;
        background: white;
        z-index: 10;
        min-width: 200px;
        text-align: left !important;
        padding-left: 1rem !important;
        border-right: 2px solid #e5e7eb !important;
    }

    .sticky-header {
        position: sticky;
        top: 0;
        background: #f9fafb;
        z-index: 5;
    }

    .sticky-header-top {
        z-index: 20;
        /* Higher than col */
    }

    .month-header {
        font-weight: bold;
        background: #f3f4f6;
        color: #374151;
    }

    .week-header {
        background: #f9fafb;
        color: #6b7280;
        width: 30px;
        min-width: 30px;
    }

    .cell-slot {
        cursor: pointer;
        width: 30px;
        height: 30px;
        min-width: 30px;
        transition: background-color 0.2s;
    }

    .cell-slot:hover {
        background-color: #f3f4f6;
    }

    .cell-slot.status-PENDING {
        background-color: #3b82f6;
        /* Blue */
        color: white;
        font-weight: bold;
    }

    .cell-slot.status-COMPLETED {
        background-color: #10b981;
        /* Green */
        color: white;
        font-weight: bold;
    }

    .equipment-row:hover td {
        background-color: #f9fafb;
    }
</style>


<div
    style="display: flex; gap: 1rem; margin-bottom: 1rem; align-items: center; justify-content: space-between; flex-wrap: wrap;">
    <!-- Year Selection -->
    <div class="card" style="margin-bottom: 0;">
        <form method="get" action="">
            <label>Año: </label>
            <select name="year" onchange="this.form.submit()"
                style="padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px;">
                {% for y in available_years %}
                <option value="{{ y }}" {% if year == y %}selected{% endif %}>{{ y }}</option>
                {% endfor %}
            </select>
        </form>
    </div>

    <!-- View Selection -->
    <div style="display: flex; gap: 0.5rem;">
        <button onclick="setView('all')" class="btn-view" id="btn-all"
            style="padding: 0.5rem 1rem; border: 1px solid #e5e7eb; background: #fff; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">Todo
            el Año</button>
        <button onclick="setView('s1')" class="btn-view" id="btn-s1"
            style="padding: 0.5rem 1rem; border: 1px solid #e5e7eb; background: #fff; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">Semestre
            1 (Ene-Jun)</button>
        <button onclick="setView('s2')" class="btn-view" id="btn-s2"
            style="padding: 0.5rem 1rem; border: 1px solid #e5e7eb; background: #fff; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">Semestre
            2 (Jul-Dic)</button>
    </div>

    <!-- Legend -->
    <div
        style="display: flex; gap: 1.5rem; align-items: center; padding: 0.5rem 1rem; background: white; border-radius: 8px; border: 1px solid #e5e7eb; width: fit-content;">
        <span style="font-size: 0.9rem; font-weight: 600; color: #374151; margin-right: 0.5rem;">Convenciones:</span>
        <div style="display: flex; align-items: center; gap: 0.5rem;">
            <span
                style="width: 16px; height: 16px; background-color: #3b82f6; border-radius: 4px; display: inline-block;"></span>
            <span style="font-size: 0.85rem; color: #4b5563;">Programados</span>
        </div>
        <div style="display: flex; align-items: center; gap: 0.5rem;">
            <span
                style="width: 16px; height: 16px; background-color: #10b981; border-radius: 4px; display: inline-block;"></span>
            <span style="font-size: 0.85rem; color: #4b5563;">Realizados</span>
        </div>
    </div>
</div>

<div class="schedule-container">
    <table class="schedule-table">
        <thead>
            <tr>
                <th rowspan="2" class="sticky-col sticky-header-top" style="z-index: 30; top:0; left:0;">Equipo / Área
                </th>
                {% for m_num, m_name in months %}
                <th colspan="4" class="month-header sticky-header col-month col-month-{{ m_num }}"
                    data-month="{{ m_num }}">{{ m_name }}</th>
                {% endfor %}
            </tr>
            <tr>
                {% for m_num, m_name in months %}
                {% for w in weeks %}
                <th class="week-header sticky-header col-month col-month-{{ m_num }}" data-month="{{ m_num }}"
                    style="top: 2rem;">S{{ w }}</th>
                {% endfor %}
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for eq in equipments %}
            <tr class="equipment-row">
                <td class="sticky-col">
                    <div style="font-weight: 600; color: #111827;">{{ eq.serial_number }}</div>
                    <div style="color: #6b7280; font-size: 0.7rem;">{{ eq.area.name|default:"-" }}</div>
                </td>

                {% for month_data in eq.schedule_row %}
                {% for w_data in month_data.weeks %}
                <td class="cell-slot col-month col-month-{{ w_data.month }} {% if w_data.data %}status-{{ w_data.data.status }}{% endif %}"
                    data-eq="{{ eq.id }}" data-month="{{ w_data.month }}" data-week="{{ w_data.week }}"
                    data-date="{{ w_data.data.date|default:'' }}" onclick="toggleSchedule(this)">
                    {% if w_data.data %}{{ w_data.data.day }}{% endif %}
                </td>
                {% endfor %}
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>


<!-- Date Selection Modal -->
<div id="dateModal"
    style="display:none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:100; justify-content:center; align-items:center;">
    <div style="background:white; padding:2rem; border-radius:8px; width:300px;">
        <h3>Programar Mantenimiento</h3>
        <p>Seleccione la fecha exacta:</p>
        <input type="date" id="modalDateInput"
            style="width:100%; padding:0.5rem; margin-bottom:1rem; border:1px solid #ccc; border-radius:4px;">
        <input type="hidden" id="modalEqId">
        <div style="display:flex; justify-content:flex-end; gap:0.5rem;">
            <button onclick="closeModal()"
                style="padding:0.5rem 1rem; border:none; background:#e5e7eb; border-radius:4px; cursor:pointer;">Cancelar</button>
            <button onclick="saveSchedule()"
                style="padding:0.5rem 1rem; border:none; background:#3b82f6; color:white; border-radius:4px; cursor:pointer;">Guardar</button>
        </div>
    </div>
</div>

<script>
    let currentCell = null;

    function toggleSchedule(cell) {
        currentCell = cell;
        const eqId = cell.getAttribute('data-eq');
        const existingDate = cell.getAttribute('data-date'); // If exists

        document.getElementById('modalEqId').value = eqId;
        const dateInput = document.getElementById('modalDateInput');

        if (existingDate) {
            // If exists, confirm delete? Or change?
            // Simple logic: If confirmed, delete.
            if (confirm("Ya existe un mantenimiento para el " + existingDate + ". ¿Desea eliminarlo?")) {
                saveSchedule(true); // Delete mode
            }
        } else {
            // New schedule
            // Pre-fill with year-month ??
            // Let user pick.
            const year = "{{ year }}";
            const month = cell.getAttribute('data-month');
            // Estimate day: Month is 1-indexed. Format YYYY-MM-01
            dateInput.value = `${year}-${month.toString().padStart(2, '0')}-01`;

            document.getElementById('dateModal').style.display = 'flex';
        }
    }

    function closeModal() {
        document.getElementById('dateModal').style.display = 'none';
        currentCell = null;
    }

    function saveSchedule(deleteMode = false) {
        const eqId = document.getElementById('modalEqId').value;
        const dateInput = document.getElementById('modalDateInput');
        const selectedDate = dateInput.value;

        if (!deleteMode && !selectedDate) {
            alert("Seleccione una fecha");
            return;
        }

        // Logic
        // If deleteMode, we need the date from the cell attribute
        const finalDate = deleteMode ? currentCell.getAttribute('data-date') : selectedDate;

        fetch("{% url 'inventory:toggle_schedule' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}" // Ensure CSRF token is sent
            },
            body: JSON.stringify({
                equipment_id: eqId,
                date: finalDate
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'added') {
                    currentCell.classList.remove('status-PENDING', 'status-COMPLETED'); // Clear old
                    currentCell.classList.add('status-' + data.state); // Add new based on response
                    // Extract day part
                    const parts = finalDate.split('-');
                    currentCell.innerText = parts[2]; // Day
                    currentCell.setAttribute('data-date', finalDate);
                    closeModal();
                } else if (data.status === 'removed') {
                    currentCell.classList.remove('status-PENDING', 'status-COMPLETED');
                    currentCell.innerText = "";
                    currentCell.removeAttribute('data-date');
                    closeModal(); // Also close modal on delete
                } else if (data.error) {
                    alert("Error: " + data.error);
                }
            })
            .catch(err => {
                console.error(err);
                alert("Error de conexión");
            });
    }

    // View Switching Logic
    function setView(mode) {
        // Reset buttons style
        document.querySelectorAll('.btn-view').forEach(btn => {
            btn.style.background = '#fff';
            btn.style.color = '#374151';
            btn.style.borderColor = '#e5e7eb';
        });

        // Highlight active button
        const activeBtn = document.getElementById('btn-' + mode);
        if (activeBtn) {
            activeBtn.style.background = '#2563eb'; // Blue 600
            activeBtn.style.color = 'white';
            activeBtn.style.borderColor = '#2563eb';
        }

        // Show/Hide Columns
        const allMonthCols = document.querySelectorAll('.col-month');
        allMonthCols.forEach(col => {
            const m = parseInt(col.getAttribute('data-month'));

            if (mode === 'all') {
                col.style.display = '';
            } else if (mode === 's1') {
                if (m >= 1 && m <= 6) col.style.display = '';
                else col.style.display = 'none';
            } else if (mode === 's2') {
                if (m >= 7 && m <= 12) col.style.display = '';
                else col.style.display = 'none';
            }
        });
    }

    // Initialize Default View (Current Semester)
    document.addEventListener('DOMContentLoaded', () => {
        const currentMonth = new Date().getMonth() + 1; // 1-12
        if (currentMonth <= 6) setView('s1');
        else setView('s2');
    });
</script>
{% endblock %}