{% extends 'inventory/base.html' %}

{% block title %}Cronograma de Mantenimiento{% endblock %}
{% block page_title %}Cronograma de Mantenimiento {{ year }}{% endblock %}

{% block content %}
<style>
    .schedule-container {
        overflow-x: auto;
        max-width: 100%;
        background: white;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .schedule-table {
        border-collapse: collapse;
        width: max-content;
        min-width: 100%;
    }

    .schedule-table th,
    .schedule-table td {
        border: 1px solid #e5e7eb;
        text-align: center;
        padding: 4px;
        font-size: 0.75rem;
    }

    .sticky-col {
        position: sticky;
        left: 0;
        background: white;
        z-index: 10;
        min-width: 200px;
        text-align: left !important;
        padding-left: 1rem !important;
        border-right: 2px solid #e5e7eb !important;
    }

    .sticky-header {
        position: sticky;
        top: 0;
        background: #f9fafb;
        z-index: 5;
    }

    .sticky-header-top {
        z-index: 20;
        /* Higher than col */
    }

    .month-header {
        font-weight: bold;
        background: #f3f4f6;
        color: #374151;
    }

    .week-header {
        background: #f9fafb;
        color: #6b7280;
        width: 30px;
        min-width: 30px;
    }

    .cell-slot {
        cursor: pointer;
        width: 30px;
        height: 30px;
        min-width: 30px;
        transition: background-color 0.2s;
    }

    .cell-slot:hover {
        background-color: #f3f4f6;
    }

    .cell-slot.active {
        background-color: #10b981;
        /* Green */
        color: white;
        font-weight: bold;
    }

    .equipment-row:hover td {
        background-color: #f9fafb;
    }
</style>

<div class="card" style="margin-bottom: 1rem;">
    <form method="get" action="">
        <label>Año: </label>
        <select name="year" onchange="this.form.submit()"
            style="padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px;">
            <option value="2024" {% if year == 2024 %}selected{% endif %}>2024</option>
            <option value="2025" {% if year == 2025 %}selected{% endif %}>2025</option>
            <option value="2026" {% if year == 2026 %}selected{% endif %}>2026</option>
        </select>
    </form>
</div>

<div class="schedule-container">
    <table class="schedule-table">
        <thead>
            <tr>
                <th rowspan="2" class="sticky-col sticky-header-top" style="z-index: 30; top:0; left:0;">Equipo / Área
                </th>
                {% for m_num, m_name in months %}
                <th colspan="4" class="month-header sticky-header">{{ m_name }}</th>
                {% endfor %}
            </tr>
            <tr>
                {% for m_num, m_name in months %}
                {% for w in weeks %}
                <th class="week-header sticky-header" style="top: 2rem;">S{{ w }}</th>
                {% endfor %}
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for eq in equipments %}
            <tr class="equipment-row">
                <td class="sticky-col">
                    <div style="font-weight: 600; color: #111827;">{{ eq.serial_number }}</div>
                    <div style="color: #6b7280; font-size: 0.7rem;">{{ eq.area.name|default:"-" }}</div>
                </td>

                {% for month_data in eq.schedule_row %}
                {% for w_data in month_data.weeks %}
                <td class="cell-slot {% if w_data.status %}active{% endif %}" data-eq="{{ eq.id }}"
                    data-month="{{ w_data.month }}" data-week="{{ w_data.week }}" onclick="toggleSchedule(this)">
                    {% if w_data.status %}X{% endif %}
                </td>
                {% endfor %}
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
    function toggleSchedule(cell) {
        const eqId = cell.getAttribute('data-eq');
        const month = cell.getAttribute('data-month');
        const week = cell.getAttribute('data-week');
        const year = "{{ year }}";

        // Optimistic update
        const wasActive = cell.classList.contains('active');
        if (wasActive) {
            cell.classList.remove('active');
            cell.innerText = "";
        } else {
            cell.classList.add('active');
            cell.innerText = "X";
        }

        fetch("{% url 'inventory:toggle_schedule' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                equipment_id: eqId,
                year: year,
                month: month,
                week: week
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert("Error: " + data.error);
                    // Revert
                    if (wasActive) {
                        cell.classList.add('active');
                        cell.innerText = "X";
                    } else {
                        cell.classList.remove('active');
                        cell.innerText = "";
                    }
                }
            })
            .catch(err => {
                console.error(err);
                alert("Error de conexión");
                // Revert
                if (wasActive) {
                    cell.classList.add('active');
                    cell.innerText = "X";
                } else {
                    cell.classList.remove('active');
                    cell.innerText = "";
                }
            });
    }
</script>
{% endblock %}