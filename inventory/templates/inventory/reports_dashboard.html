{% extends 'inventory/base.html' %}
{% load static %}

{% block title %}Reportes{% endblock %}
{% block page_title %}Reportes y An√°lisis{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Date Filter Form -->
<div class="card" style="margin-bottom: 2rem;">
    <form method="get" style="display: flex; gap: 1rem; align-items: flex-end; flex-wrap: wrap;">
        <div style="flex: 1; min-width: 150px;">
            <label style="display: block; font-size: 0.875rem; color: #6b7280; margin-bottom: 0.25rem;">Fecha
                Inicio</label>
            <input type="date" name="start_date" value="{{ start_date }}"
                style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
        </div>
        <div style="flex: 1; min-width: 150px;">
            <label style="display: block; font-size: 0.875rem; color: #6b7280; margin-bottom: 0.25rem;">Fecha
                Fin</label>
            <input type="date" name="end_date" value="{{ end_date }}"
                style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
        </div>
        <div>
            <button type="submit" class="btn btn-primary">üîç Filtrar Datos</button>
            <a href="{% url 'inventory:export_report_pdf' %}{% if request.GET %}?{{ request.GET.urlencode }}{% endif %}"
                class="btn" target="_blank" style="background-color: #ef4444; color: white; margin-left: 0.5rem;">üìÑ
                Exportar PDF</a>
            <a href="{% url 'inventory:reports_dashboard' %}" class="btn"
                style="background-color: #9ca3af; margin-left: 0.5rem;">Limpiar</a>
        </div>
    </form>
    </form>
</div>

<!-- Alerts Section -->
{% if low_stock_peripherals %}
<div class="card" style="border-left: 4px solid #ef4444; margin-bottom: 2rem; background-color: #fef2f2;">
    <h3 style="color: #b91c1c; margin-top: 0; display: flex; align-items: center; gap: 0.5rem;">
        ‚ö†Ô∏è Alerta de Stock Bajo
    </h3>
    <table style="width: 100%; border-collapse: collapse; margin-top: 0.5rem;">
        <thead>
            <tr style="text-align: left; border-bottom: 1px solid #fecaca;">
                <th style="padding: 0.5rem; color: #991b1b;">Perif√©rico</th>
                <th style="padding: 0.5rem; color: #991b1b;">Stock Actual</th>
                <th style="padding: 0.5rem; color: #991b1b;">M√≠nimo</th>
                <th style="padding: 0.5rem;">Acci√≥n</th>
            </tr>
        </thead>
        <tbody>
            {% for p in low_stock_peripherals %}
            <tr style="border-bottom: 1px solid #fee2e2;">
                <td style="padding: 0.5rem; color: #b91c1c;">{{ p.type.name }} - {{ p.brand }} {{ p.model }}</td>
                <td style="padding: 0.5rem; font-weight: bold; color: #dc2626;">{{ p.quantity }}</td>
                <td style="padding: 0.5rem; color: #b91c1c;">{{ p.min_stock_level }}</td>
                <td style="padding: 0.5rem;">
                    <a href="{% url 'inventory:peripheral_edit' p.pk %}"
                        style="color: #dc2626; text-decoration: underline; font-size: 0.9rem;">Gestionar</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<!-- KPI Row -->
<div
    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
    <div class="card" style="border-left: 4px solid #3b82f6; text-align: center;">
        <h4 style="margin: 0; color: #6b7280; font-weight: 500;">Total Equipos</h4>
        <div style="font-size: 2.5rem; font-weight: 800; color: #1f2937;">{{ total_equipment }}</div>
        <div style="font-size: 0.875rem; color: #10b981;">{{ active_equipment }} Activos</div>
    </div>
    <div class="card" style="border-left: 4px solid #f59e0b; text-align: center;">
        <h4 style="margin: 0; color: #6b7280; font-weight: 500;">Mantenimientos</h4>
        <div style="font-size: 2.5rem; font-weight: 800; color: #1f2937;">{{ maintenance_count }}</div>
        <div style="font-size: 0.875rem; color: #6b7280;">En el periodo seleccionado</div>
    </div>
    <div class="card" style="border-left: 4px solid #8b5cf6; text-align: center;">
        <h4 style="margin: 0; color: #6b7280; font-weight: 500;">Entregas</h4>
        <div style="font-size: 2.5rem; font-weight: 800; color: #1f2937;">{{ handover_count }}</div>
        <div style="font-size: 0.875rem; color: #6b7280;">En el periodo seleccionado</div>
    </div>
</div>

<!-- Charts Row 1 -->
<div
    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 2rem; margin-bottom: 2rem;">
    <div class="card">
        <h3>Equipos por Tipo</h3>
        <div style="height: 300px; position: relative;">
            <canvas id="typeChart"></canvas>
        </div>
    </div>
    <div class="card">
        <h3>Tipos de Mantenimiento</h3>
        <div style="height: 300px; position: relative;">
            <canvas id="maintChart"></canvas>
        </div>
    </div>
</div>

<!-- Charts Row 2 -->
<div
    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 2rem; margin-bottom: 2rem;">
    <div class="card">
        <h3>Top 5 T√©cnicos (Mantenimientos)</h3>
        <div style="height: 300px; position: relative;">
            <canvas id="techChart"></canvas>
        </div>
    </div>
    <div class="card">
        <h3>Estado de Equipos</h3>
        <div style="height: 300px; position: relative;">
            <canvas id="statusChart"></canvas>
        </div>
    </div>
</div>

<!-- Charts Row 3 -->
<div
    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 2rem; margin-bottom: 2rem;">
    <div class="card">
        <h3>Entregas por Tipo</h3>
        <div style="height: 300px; position: relative;">
            <canvas id="handTypeChart"></canvas>
        </div>
    </div>
    <div class="card">
        <h3>Entregas por √Årea Destino</h3>
        <div style="height: 300px; position: relative;">
            <canvas id="handAreaChart"></canvas>
        </div>
    </div>
</div>

<!-- Warranty Alert Table -->
<div class="card">
    <h3 style="color: #ef4444; display: flex; align-items: center; gap: 0.5rem;">
        ‚ö†Ô∏è Garant√≠as pr√≥ximas a vencer (90 d√≠as)
    </h3>
    <div style="overflow-x: auto;">
        <table>
            <thead>
                <tr>
                    <th>Fecha Vencimiento</th>
                    <th>D√≠as Restantes</th>
                    <th>Equipo</th>
                    <th>Serial</th>
                    <th>√Årea</th>
                </tr>
            </thead>
            <tbody>
                {% for eq in warranty_expiring %}
                <tr>
                    <td style="font-weight: bold;">{{ eq.warranty_expiry|date:"d M Y" }}</td>
                    <td>
                        <span
                            style="background: #fee2e2; color: #991b1b; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem;">
                            {{ eq.warranty_expiry|timeuntil:None }}
                        </span>
                    </td>
                    <td>{{ eq.get_type_display }} - {{ eq.brand }}</td>
                    <td>{{ eq.serial_number }}</td>
                    <td>{{ eq.area.name|default:"-" }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" style="text-align: center; color: #6b7280; padding: 2rem;">
                        ‚úÖ No hay garant√≠as venciendo pr√≥ximamente.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

</div>

<!-- Expired Warranty Table -->
<div class="card" style="margin-top: 2rem; border-left: 4px solid #b91c1c;">
    <h3 style="color: #b91c1c; display: flex; align-items: center; gap: 0.5rem;">
        üö´ Garant√≠as Vencidas
    </h3>
    <div style="overflow-x: auto;">
        <table>
            <thead>
                <tr>
                    <th>Fecha Vencimiento</th>
                    <th>Equipo</th>
                    <th>Serial</th>
                    <th>√Årea</th>
                </tr>
            </thead>
            <tbody>
                {% for eq in warranty_expired %}
                <tr>
                    <td style="font-weight: bold; color: #b91c1c;">{{ eq.warranty_expiry|date:"d M Y" }}</td>
                    <td>{{ eq.get_type_display }} - {{ eq.brand }}</td>
                    <td>{{ eq.serial_number }}</td>
                    <td>{{ eq.area.name|default:"-" }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="4" style="text-align: center; color: #6b7280; padding: 2rem;">
                        ‚úÖ No hay garant√≠as vencidas.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Expired Lifespan Table -->
<div class="card" style="margin-top: 2rem; border-left: 4px solid #b91c1c;">
    <h3 style="color: #b91c1c; display: flex; align-items: center; gap: 0.5rem;">
        üíÄ Vida √ötil Vencida
    </h3>
    <div style="overflow-x: auto;">
        <table>
            <thead>
                <tr>
                    <th>Fin Vida √ötil</th>
                    <th>Equipo</th>
                    <th>Serial</th>
                    <th>√Årea</th>
                </tr>
            </thead>
            <tbody>
                {% for eq in lifespan_expired %}
                <tr>
                    <td style="font-weight: bold; color: #b91c1c;">{{ eq.end_of_life_date|date:"d M Y" }}</td>
                    <td>{{ eq.get_type_display }} - {{ eq.brand }}</td>
                    <td>{{ eq.serial_number }}</td>
                    <td>{{ eq.area.name|default:"-" }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="4" style="text-align: center; color: #6b7280; padding: 2rem;">
                        ‚úÖ No hay equipos con vida √∫til vencida.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    // --- Data Preparation ---
    const typeData = {{ eq_by_type| safe }};
    const maintData = {{ m_by_type| safe }};
    const techData = {{ top_techs| safe }};
    const statusData = {{ eq_by_status| safe }};
    const handTypeData = {{ handover_by_type| safe }};
    const handAreaData = {{ handover_by_area| safe }};

    // --- Chart 1: Equipment Types ---
    new Chart(document.getElementById('typeChart'), {
        type: 'doughnut',
        data: {
            labels: typeData.map(d => d.type), // Note: Should ideally map to display names
            datasets: [{
                data: typeData.map(d => d.count),
                backgroundColor: ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899', '#6366f1'],
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'right' } }
        }
    });

    // --- Chart 2: Maintenance Types ---
    new Chart(document.getElementById('maintChart'), {
        type: 'pie',
        data: {
            labels: maintData.map(d => d.maintenance_type === 'PREVENTIVE' ? 'Preventivo' : 'Correctivo'),
            datasets: [{
                data: maintData.map(d => d.count),
                backgroundColor: ['#10b981', '#ef4444'], // Green for Prev, Red for Corr
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
        }
    });

    // --- Chart 3: Top Techs ---
    new Chart(document.getElementById('techChart'), {
        type: 'bar',
        data: {
            labels: techData.map(d => d.performed_by__username),
            datasets: [{
                label: 'Mantenimientos Realizados',
                data: techData.map(d => d.count),
                backgroundColor: '#3b82f6',
                borderRadius: 4
            }]
        },
        options: {
            indexAxis: 'y', // Horizontal bar
            responsive: true,
            maintainAspectRatio: false,
            scales: { x: { beginAtZero: true } },
            plugins: { legend: { display: false } }
        }
    });

    // --- Chart 4: Status ---
    new Chart(document.getElementById('statusChart'), {
        type: 'bar',
        data: {
            labels: statusData.map(d => d.status),
            datasets: [{
                label: 'Estado',
                data: statusData.map(d => d.count),
                backgroundColor: ['#10b981', '#ef4444', '#f59e0b', '#9ca3af'],
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: true } },
            plugins: { legend: { display: false } }
        }
    });

    // --- Chart 5: Handover Type ---
    new Chart(document.getElementById('handTypeChart'), {
        type: 'pie',
        data: {
            labels: handTypeData.map(d => d.type === 'ASSIGNMENT' ? 'Asignaci√≥n' : (d.type === 'RETURN' ? 'Devoluci√≥n' : d.type)),
            datasets: [{
                data: handTypeData.map(d => d.count),
                backgroundColor: ['#8e44ad', '#d35400', '#2980b9'],
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
        }
    });

    // --- Chart 6: Handover Area ---
    new Chart(document.getElementById('handAreaChart'), {
        type: 'bar',
        data: {
            labels: handAreaData.map(d => d.destination_area__name || 'N/A'),
            datasets: [{
                label: 'Entregas',
                data: handAreaData.map(d => d.count),
                backgroundColor: '#d35400',
                borderRadius: 4
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            scales: { x: { beginAtZero: true } },
            plugins: { legend: { display: false } }
        }
    });
</script>
{% endblock %}