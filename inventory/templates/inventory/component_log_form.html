{% extends 'inventory/base.html' %}
{% load static %}

{% block content %}
<div class="content">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <div>
            <h2>Registrar Cambio de Componente</h2>
            <p style="color: #6b7280;">Registra una adición, retiro o mejora de hardware en la Hoja de Vida.</p>
        </div>
        <a href="{% url 'inventory:equipment_history' equipment.pk %}" class="btn"
            style="background: #e2e8f0; color: #475569;">
            <i class="fas fa-arrow-left"></i> Volver a Hoja de Vida
        </a>
    </div>

    <div class="card" style="max-width: 600px; margin: 0 auto;">
        <div style="margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid #e5e7eb;">
            <h4 style="margin: 0; color: #1f2937;">Equipo: {{ equipment.serial_number }}</h4>
            <p style="margin: 0; font-size: 0.9rem; color: #6b7280;">{{ equipment.brand }} {{ equipment.model }}</p>
        </div>

        <form method="post">
            {% csrf_token %}
            {% for error in form.non_field_errors %}
            <div
                style="padding: 1rem; background-color: #fee2e2; color: #b91c1c; border-radius: 6px; margin-bottom: 1rem;">
                {{ error }}
            </div>
            {% endfor %}

            <div class="form-group">
                <label for="{{ form.action_type.id_for_label }}" class="form-label">Acción Realizada</label>
                {{ form.action_type }}
                {% if form.action_type.errors %}
                <span style="color: #ef4444; font-size: 0.85rem;">{{ form.action_type.errors|join:", " }}</span>
                {% endif %}
            </div>

            <!-- New Stock Integration Fields -->
            <div
                style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; padding: 1rem; margin-bottom: 2rem;">
                <h5 style="margin-top: 0; color: #334155; font-size: 0.95rem; margin-bottom: 1rem;"><i
                        class="fas fa-boxes"></i> Asignación desde Stock de Periféricos</h5>

                <div class="form-group" style="margin-bottom: 1rem;">
                    <label for="{{ form.peripheral.id_for_label }}" class="form-label">Seleccionar Pieza del
                        Inventario</label>
                    {{ form.peripheral }}
                    {% if form.peripheral.errors %}
                    <span style="color: #ef4444; font-size: 0.85rem;">{{ form.peripheral.errors|join:", " }}</span>
                    {% endif %}
                    <small style="color: #64748b; display: block; margin-top: 5px;">Si la acción es "Agregado" o
                        "Reemplazado", la cantidad se descontará del inventario global al guardar.</small>
                </div>

                <div class="form-group" style="margin-bottom: 0;">
                    <label for="{{ form.quantity.id_for_label }}" class="form-label">Cantidad a Usar</label>
                    {{ form.quantity }}
                    {% if form.quantity.errors %}
                    <span style="color: #ef4444; font-size: 0.85rem;">{{ form.quantity.errors|join:", " }}</span>
                    {% endif %}
                </div>
            </div>

            <div class="form-group">
                <label for="{{ form.component_name.id_for_label }}" class="form-label">Descripción Manual</label>
                {{ form.component_name }}
                {% if form.component_name.errors %}
                <span style="color: #ef4444; font-size: 0.85rem;">{{ form.component_name.errors|join:", " }}</span>
                {% endif %}
                <small style="color: #6b7280; display: block; margin-top: 5px;">Opcional si eligió Pieza arriba. Ej:
                    Limpieza Interna, Cambio Pasta Térmica, etc.</small>
            </div>

            <div class="form-group">
                <label for="{{ form.description.id_for_label }}" class="form-label">Descripción Detallada</label>
                {{ form.description }}
                {% if form.description.errors %}
                <span style="color: #ef4444; font-size: 0.85rem;">{{ form.description.errors|join:", " }}</span>
                {% endif %}
            </div>

            <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                <button type="submit" class="btn btn-primary" style="flex: 1;">
                    <i class="fas fa-save"></i> Guardar Registro
                </button>
                <a href="{% url 'inventory:equipment_history' equipment.pk %}" class="btn"
                    style="background: #e5e7eb; color: #374151; flex: 1; text-align: center;">Cancelar</a>
            </div>
        </form>
    </div>
</div>
{% endblock %}