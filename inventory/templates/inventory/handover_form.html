{% extends 'inventory/base.html' %}

{% block title %}{{ title|default:"Nueva Entrega" }}{% endblock %}
{% block page_title %}{{ title|default:"Nueva Acta de Entrega" }}{% endblock %}

{% block content %}
<div class="card" style="max-width: 900px; margin: 0 auto;">
    <form method="post">
        {% csrf_token %}

        <div style="display: grid; grid-template-columns: 1fr; gap: 1.5rem; margin-bottom: 2rem;">
            <!-- Peripherals Section -->
            <div class="card"
                style="border: 1px solid #e5e7eb; padding: 1.5rem; border-radius: 0.5rem; background-color: #f9fafb;">
                <h4 style="margin-top: 0; margin-bottom: 1rem; font-size: 1.1rem; color: #374151;">Selecci√≥n de
                    Perif√©ricos</h4>
                <div class="form-group">
                    {{ formset.management_form }}
                    <div id="peripherals-formset">
                        {% for form in formset %}
                        <div class="peripheral-row"
                            style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; background-color: white;">
                            {{ form.id }}
                            <div style="flex-grow: 1;">
                                {{ form.peripheral.label_tag }}
                                {{ form.peripheral }}
                            </div>
                            <div style="width: 100px;">
                                {{ form.quantity.label_tag }}
                                {{ form.quantity }}
                            </div>
                            {% if form.instance.pk %}
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <label for="{{ form.DELETE.id_for_label }}"
                                    style="margin: 0; font-size: 0.9em; color: #ef4444;">Eliminar</label>
                                {{ form.DELETE }}
                            </div>
                            {% endif %}
                            {% if form.errors %}
                            <div style="color: #ef4444; font-size: 0.8rem;">{{ form.errors }}</div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>

                    <button type="button" id="add-peripheral-btn" class="btn btn-sm"
                        style="background-color: #10b981; color: white; margin-top: 5px;">
                        + Agregar Perif√©rico
                    </button>

                    <!-- Empty Form Template (Hidden) -->
                    <div id="empty-form" style="display:none;">
                        <div class="peripheral-row"
                            style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; background-color: white;">
                            {{ formset.empty_form.id }}
                            <div style="flex-grow: 1;">
                                {{ formset.empty_form.peripheral }}
                            </div>
                            <div style="width: 100px;">
                                <input type="number" name="handoverperipheral_set-__prefix__-quantity" value="1" min="1"
                                    class="form-control" style="width: 80px;"
                                    id="id_handoverperipheral_set-__prefix__-quantity">
                            </div>
                            <button type="button" class="btn btn-sm btn-danger remove-row"
                                style="color: white; background-color: #ef4444; border: none; padding: 2px 8px; border-radius: 4px;">X</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Equipment Section -->
            <div class="card"
                style="border: 1px solid #e5e7eb; padding: 1.5rem; border-radius: 0.5rem; background-color: #f9fafb;">
                <h4 style="margin-top: 0; margin-bottom: 1rem; font-size: 1.1rem; color: #374151;">Selecci√≥n de Equipos
                </h4>
                <div class="form-group">
                    <div id="equipment-container">
                        <!-- Dynamic Equipment Rows will appear here -->
                    </div>

                    <button type="button" id="add-equipment-btn" class="btn btn-sm"
                        style="background-color: #3b82f6; color: white; margin-top: 5px;">
                        + Agregar Equipo
                    </button>

                    <!-- Hidden Source Select to copy options from -->
                    <select id="equipment-options-source" style="display: none;">
                        <option value="" selected disabled>---------</option>
                        {% for x in form.equipment.field.queryset %}
                        <option value="{{ x.id }}">{{ x }}</option>
                        {% endfor %}
                    </select>

                    <div id="equipment-errors" style="margin-top: 5px;">
                        {% if form.equipment.errors %}
                        <div style="color: #ef4444; font-size: 0.8rem;">{{ form.equipment.errors }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <h3
            style="margin-bottom: 1.5rem; color: #111827; font-size: 1.25rem; border-top: 1px solid #e5e7eb; padding-top: 1rem;">
            Informaci√≥n General</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
            <div class="form-group">
                <label for="{{ form.type.id_for_label }}"
                    style="display: block; margin-bottom: 0.5rem; font-weight: 500;">
                    {{ form.type.label }}
                </label>
                {{ form.type }}
                {% if form.type.errors %}
                <div style="color: #ef4444; font-size: 0.8rem;">{{ form.type.errors }}</div>
                {% endif %}
            </div>

            <div class="form-group">
                <label for="{{ form.client.id_for_label }}"
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; font-weight: 500;">
                    {{ form.client.label }}
                    <a href="{% url 'inventory:client_create' %}?next={% url 'inventory:handover_create' %}"
                        style="font-size: 0.8rem; color: #3b82f6; text-decoration: none;">‚ûï Nuevo Cliente</a>
                </label>
                {{ form.client }}
                {% if form.client.errors %}
                <div style="color: #ef4444; font-size: 0.8rem;">{{ form.client.errors }}</div>
                {% endif %}
            </div>

            <div class="form-group">
                <label for="{{ form.source_area.id_for_label }}"
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; font-weight: 500;">
                    {{ form.source_area.label }}
                    <a href="{% url 'inventory:area_create' %}?next={% url 'inventory:handover_create' %}"
                        style="font-size: 0.8rem; color: #3b82f6; text-decoration: none;">‚ûï Nueva √Årea</a>
                </label>
                {{ form.source_area }}
                {% if form.source_area.errors %}
                <div style="color: #ef4444; font-size: 0.8rem;">{{ form.source_area.errors }}</div>
                {% endif %}
            </div>

            <div class="form-group">
                <label for="{{ form.destination_area.id_for_label }}"
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; font-weight: 500;">
                    {{ form.destination_area.label }}
                    <a href="{% url 'inventory:area_create' %}?next={% url 'inventory:handover_create' %}"
                        style="font-size: 0.8rem; color: #3b82f6; text-decoration: none;">‚ûï Nueva √Årea</a>
                </label>
                {{ form.destination_area }}
                {% if form.destination_area.errors %}
                <div style="color: #ef4444; font-size: 0.8rem;">{{ form.destination_area.errors }}</div>
                {% endif %}
            </div>

            <div class="form-group" style="grid-column: 1 / -1;">
                <label for="{{ form.receiver_name.id_for_label }}"
                    style="display: block; margin-bottom: 0.5rem; font-weight: 500;">
                    {{ form.receiver_name.label }}
                </label>
                {{ form.receiver_name }}
                <p style="font-size: 0.8rem; color: #6b7280; margin-top: 0.25rem;">Opcional si es diferente al cliente
                    seleccionado.</p>
                {% if form.receiver_name.errors %}
                <div style="color: #ef4444; font-size: 0.8rem;">{{ form.receiver_name.errors }}</div>
                {% endif %}
            </div>
        </div>

        <h3
            style="margin-bottom: 1.5rem; color: #111827; font-size: 1.25rem; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
            Observaciones</h3>
        <div class="form-group" style="margin-bottom: 2rem;">
            {{ form.observations }}
            {% if form.observations.errors %}
            <div style="color: #ef4444; font-size: 0.8rem;">{{ form.observations.errors }}</div>
            {% endif %}
        </div>

        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
            <a href="{% url 'inventory:dashboard' %}" class="btn" style="background-color: #6b7280;">Cancelar</a>
            <button type="submit" name="action" value="preview" class="btn" style="background-color: #3b82f6;"
                formtarget="_blank">üëÅÔ∏è Previsualizar PDF</button>
            <button type="submit" name="action" value="save" class="btn btn-primary">Generar Acta de Entrega</button>
        </div>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Data Mappings from View
        const equipmentAreaMap = JSON.parse('{{ equipment_area_map|escapejs }}');
        const peripheralAreaMap = JSON.parse('{{ peripheral_area_map|escapejs }}');

        const sourceAreaSelect = document.getElementById('{{ form.source_area.id_for_label }}');

        // Function to update Source Area
        function updateSourceArea(areaId) {
            if (areaId && sourceAreaSelect) {
                sourceAreaSelect.value = areaId;
                // Highlight change
                sourceAreaSelect.style.backgroundColor = '#e0f2fe';
                setTimeout(() => sourceAreaSelect.style.backgroundColor = '', 1000);
            }
        }

        // Equipment Selection Logic (Dynamic Rows)
        const addEquipBtn = document.getElementById('add-equipment-btn');
        const equipContainer = document.getElementById('equipment-container');
        const equipSourceSelect = document.getElementById('equipment-options-source');

        function addEquipmentRow(selectedValue = null) {
            const row = document.createElement('div');
            row.className = 'equipment-row';
            row.style.cssText = 'display: flex; gap: 10px; align-items: center; margin-bottom: 10px; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; background-color: white;';

            // Create Select
            const select = document.createElement('select');
            select.name = 'equipment'; // Crucial for Django ModelMultipleChoiceField
            select.className = 'form-select';
            select.style.flexGrow = '1';
            select.innerHTML = equipSourceSelect.innerHTML;
            if (selectedValue) select.value = selectedValue;

            // Remove Button
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'btn btn-sm btn-danger remove-equip-row';
            removeBtn.style.cssText = 'color: white; background-color: #ef4444; border: none; padding: 2px 8px; border-radius: 4px;';
            removeBtn.textContent = 'X';

            row.appendChild(select);
            row.appendChild(removeBtn);
            equipContainer.appendChild(row);
        }

        if (addEquipBtn) {
            addEquipBtn.addEventListener('click', () => addEquipmentRow());
        }

        // Event delegation for Equipment Container
        if (equipContainer) {
            equipContainer.addEventListener('click', function (e) {
                if (e.target.classList.contains('remove-equip-row')) {
                    e.target.closest('.equipment-row').remove();
                }
            });

            equipContainer.addEventListener('change', function (e) {
                if (e.target.tagName === 'SELECT' && e.target.name === 'equipment') {
                    const val = String(e.target.value);
                    const areaId = equipmentAreaMap[val];
                    if (areaId) updateSourceArea(areaId);
                }
            });

            // Initial population (for validation errors or edit)
            const initialEquipment = [
                {% if form.equipment.value %}
        {% for val in form.equipment.value %}
        "{{ val }}",
            {% endfor %}
            {% endif %}
            ];

    if (initialEquipment.length > 0) {
        initialEquipment.forEach(val => addEquipmentRow(val));
    } else if (equipContainer.children.length === 0) {
        addEquipmentRow();
    }
        }

    // --- Formset Logic ---
    const addBtn = document.getElementById('add-peripheral-btn');
    const container = document.getElementById('peripherals-formset');
    const totalForms = document.getElementById('id_handoverperipheral_set-TOTAL_FORMS');

    const emptyFormTemplateDiv = document.getElementById('empty-form');
    const emptyFormHtml = emptyFormTemplateDiv.innerHTML;

    addBtn.addEventListener('click', function () {
        const count = parseInt(totalForms.value);
        const newFormHtml = emptyFormHtml.replace(/__prefix__/g, count);
        container.insertAdjacentHTML('beforeend', newFormHtml);
        totalForms.value = count + 1;
    });

    // Event delegation for Remove buttons AND Peripheral selection change
    container.addEventListener('click', function (e) {
        if (e.target.classList.contains('remove-row')) {
            e.target.closest('.peripheral-row').remove();
            updateFormIndices();
        }
    });

    // Listen for changes in peripheral selects within the formset
    container.addEventListener('change', function (e) {
        if (e.target.tagName === 'SELECT' && e.target.name.includes('peripheral')) {
            const peripheralId = String(e.target.value);
            const areaId = peripheralAreaMap[peripheralId];
            if (areaId) updateSourceArea(areaId);
        }
    });

    function updateFormIndices() {
        const rows = container.querySelectorAll('.peripheral-row');
        totalForms.value = rows.length;
        rows.forEach((row, index) => {
            row.querySelectorAll('input, select, label').forEach(el => {
                const regex = /handoverperipheral_set-(\d+|__prefix__)-/;
                const replacement = `handoverperipheral_set-${index}-`;
                if (el.id) el.id = el.id.replace(regex, replacement);
                if (el.name) el.name = el.name.replace(regex, replacement);
                if (el.htmlFor) el.htmlFor = el.htmlFor.replace(regex, replacement);
            });
        });
    }
    });
</script>
{% endblock %}